---
title: "Question 3 Script"
author: "Janice Jiang"
date: "2025-10-26"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(infer)
library(randomForest)
library(tidymodels)
library(modelr)
library(yardstick)
load('/Users/lucycao/Desktop/pstat 122/module-1-biomarker-data-table_14/data/biomarker-clean.RData')
```

```{r}
# split the dataset
set.seed(2015)
split = biomarker_clean %>% initial_split(prop=0.8)
train_data = split %>% training()
test_data = split %>% testing()
```

```{r}
## MULTIPLE TESTING
####################

# function to compute tests
test_fn <- function(.df){
  t_test(.df, 
         formula = level ~ group,
         order = c('ASD', 'TD'),
         alternative = 'two-sided',
         var.equal = F)
}

ttests_out <- train_data %>%
  # drop ADOS score
  select(-ados) %>%
  # arrange in long format
  pivot_longer(-group, 
               names_to = 'protein', 
               values_to = 'level') %>%
  # nest by protein
  nest(data = c(level, group)) %>% 
  # compute t tests
  mutate(ttest = map(data, test_fn)) %>%
  unnest(ttest) %>%
  # sort by p-value
  arrange(p_value) %>%
  # multiple testing correction
  mutate(m = n(),
         hm = log(m) + 1/(2*m) - digamma(1),
         rank = row_number(),
         p.adj = m*hm*p_value/rank)

# select significant proteins
proteins_s1 <- ttests_out %>%
  slice_min(p.adj, n = 15) %>%
  pull(protein)
```

```{r}
## RANDOM FOREST
##################

# store predictors and response separately
predictors <- train_data %>%
  select(-c(group, ados))

response <- train_data %>% pull(group) %>% factor()

# fit RF
set.seed(101422)
rf_out <- randomForest(x = predictors, 
                       y = response, 
                       ntree = 2000, 
                       importance = T)

# check errors
rf_out$confusion

# compute importance scores
proteins_s2 <- rf_out$importance %>% 
  as_tibble() %>%
  mutate(protein = rownames(rf_out$importance)) %>%
  slice_max(MeanDecreaseGini, n = 15) %>%
  pull(protein)
```

```{r}
# logistic regression
proteins_sstar <- union(proteins_s1, proteins_s2)

biomarker_sstar <- train_data %>%
  select(group, any_of(proteins_sstar)) %>%
  mutate(class = (group == 'ASD')) %>%
  select(-group)

# fit logistic regression model to training set
fit <- glm(class ~ ., 
           data = biomarker_sstar, 
           family = 'binomial')

test_sstar <- test_data %>%
  select(group, any_of(proteins_sstar)) %>%
  mutate(class = (group == 'ASD')) %>%
  select(-group) %>%
  mutate(
    class = factor(class, levels = c(FALSE, TRUE)),   # ðŸ‘ˆ convert truth to factor
    pred = predict(fit, newdata = ., type = "response"),
    pred_class = factor(if_else(pred > 0.5, TRUE, FALSE), levels = c(FALSE, TRUE))
  )

class_metrics <- metric_set(sensitivity, specificity, accuracy, roc_auc)

class_metrics(
  test_sstar,
  truth = class,
  estimate = pred_class,
  pred)
```

# test for different n

```{r}
set.seed(2017)
# vector of n values to evaluate
ns <- 10:20
roc_results <- tibble(n = ns, roc_auc = NA_real_)   # initialise results table

for (i in seq_along(ns)) {
  n <- ns[i]

  ## -------- choose top markers at this n --------
  proteins_s1 <- ttests_out %>% 
    slice_min(p.adj, n = n) %>% 
    pull(protein)

  proteins_s2 <- rf_out$importance %>% 
    as_tibble() %>% 
    mutate(protein = rownames(rf_out$importance)) %>% 
    slice_max(MeanDecreaseGini, n = n) %>% 
    pull(protein)

  proteins_sstar <- union(proteins_s1, proteins_s2)

  ## -------- fit logistic regression --------
  train_sstar <- train_data %>% 
    select(group, any_of(proteins_sstar)) %>% 
    mutate(class = (group == "ASD")) %>% 
    select(-group)

  fit <- glm(class ~ ., data = train_sstar, family = binomial)

  ## -------- predict & compute ROC AUC --------
  test_sstar <- test_data %>% 
    select(group, any_of(proteins_sstar)) %>% 
    mutate(class = (group == "ASD")) %>% 
    select(-group) %>% 
    mutate(
      class = factor(class, levels = c(FALSE, TRUE)),
      pred  = predict(fit, newdata = ., type = "response")
    )

  roc_val <- roc_auc(test_sstar, truth = class, pred)$.estimate
  roc_results$roc_auc[i] <- 1-roc_val
  roc_results$core_protein[i] = length(proteins_sstar)
}

print(roc_results)
```

Conclusion: n=17 for each method is the best one, we take union, so there are 26 proteins used in the final model.

